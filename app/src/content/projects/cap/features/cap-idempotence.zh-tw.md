冪等性（你可以在[Wikipedia](https://en.wikipedia.org/wiki/Idempotence)讀到關於冪等性的定義），當我們談論冪等時，一般是指可以重複處理傳遞的消息，而不會產生意外的結果。



由於CAP不是使用的 MS DTC 或其他類型的2PC分布式事務機制，所以存在至少消息嚴格交付一次的問題，具體的說在基於消息的系統中，存在以下三種可能：

- Exactly Once(*) （僅有一次）
- At Most Once （最多一次）
- At Least Once （最少一次）

帶 * 號表示在實際場景中，很難達到。



在 CAP 中，我們采用的交付保證為 At Least Once。



> 這個交付保證包含你收到至少一次的消息，當出現故障時，可能會收到多次消息。
>
> 它需要稍微改變我們執行步驟的順序，它要求消息隊列系統支持事務或ACK機制，比如傳統的 begin-commit-rollback 協議（MSMQ是這樣），或者是 receive-ack-nack 協議（RabbitMQ，Azure Service Bus等是這樣的）。
>
> 大致步驟如下:
>
> ```
> 1. 搶占隊列中的消息。
> 2. 開始一個工作事務
> 3. 處理消息 ( 你的代碼 )
> 4. 是否成功 ?
>     Yes: 
>         1. 提交工作事務
>         2. 從隊列刪除消息
>     No: 
>         1. 回滾工作事務
>         2. 從隊列釋放搶占的消息
> ```
>
> 當出現失敗或者搶占消息超時的時候，我們總是能夠再次接收到消息以保證我們工作事務提交成功。



由於我們具有臨時存儲介質（數據庫表），也許可以做到 At Most Once, 但是為了嚴格保證消息不會丟失，我們沒有提供相關功能或配置。



更多關於 CAP 冪等性的信息，請[閱讀文檔](https://cap.dotnetcore.xyz/user-guide/zh/cap/idempotence/)。