幂等性（你可以在[Wikipedia](https://en.wikipedia.org/wiki/Idempotence)读到关于幂等性的定义），当我们谈论幂等时，一般是指可以重复处理传递的消息，而不会产生意外的结果。



由于CAP不是使用的 MS DTC 或其他类型的2PC分布式事务机制，所以存在至少消息严格交付一次的问题，具体的说在基于消息的系统中，存在以下三种可能：

- Exactly Once(*) （仅有一次）
- At Most Once （最多一次）
- At Least Once （最少一次）

带 * 号表示在实际场景中，很难达到。



在 CAP 中，我们采用的交付保证为 At Least Once。



> 这个交付保证包含你收到至少一次的消息，当出现故障时，可能会收到多次消息。
>
> 它需要稍微改变我们执行步骤的顺序，它要求消息队列系统支持事务或ACK机制，比如传统的 begin-commit-rollback 协议（MSMQ是这样），或者是 receive-ack-nack 协议（RabbitMQ，Azure Service Bus等是这样的）。
>
> 大致步骤如下:
>
> ```
> 1. 抢占队列中的消息。
> 2. 开始一个工作事务
> 3. 处理消息 ( 你的代码 )
> 4. 是否成功 ?
>     Yes: 
>         1. 提交工作事务
>         2. 从队列删除消息
>     No: 
>         1. 回滚工作事务
>         2. 从队列释放抢占的消息
> ```
>
> 当出现失败或者抢占消息超时的时候，我们总是能够再次接收到消息以保证我们工作事务提交成功。



由于我们具有临时存储介质（数据库表），也许可以做到 At Most Once, 但是为了严格保证消息不会丢失，我们没有提供相关功能或配置。



更多关于 CAP 幂等性的信息，请[阅读文档](https://cap.dotnetcore.xyz/user-guide/zh/cap/idempotence/)。